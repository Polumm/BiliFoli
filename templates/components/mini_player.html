<div id="miniPlayerWrapper"
     class="sticky top-0 z-30 mb-8 hidden
            transition-all duration-300 ease-in-out
            bg-white/80 backdrop-blur pb-4">

  <!-- video -->
  <video id="miniPlayerVideo"
         preload="metadata" muted loop
         playsinline webkit-playsinline controls
         x-webkit-airplay="allow"
         class="w-full h-[460px] rounded-lg shadow-md bg-black"></video>

  <!-- tap-to-unmute overlay -->
  <button id="unmuteOverlay"
          class="absolute inset-0 flex items-center justify-center
                 text-white text-xl font-semibold bg-black/50
                 backdrop-blur-sm rounded-lg hidden">
    ğŸ”Š Tap to unmute
  </button>

  <!-- PiP helper -->
  <button id="pipBtn"
          class="mt-2 px-4 py-1 bg-blue-600 text-white rounded">
    ğŸ§ Play in background
  </button>
</div>

<script>
(() => {
  const video   = document.getElementById('miniPlayerVideo');
  const pipBtn  = document.getElementById('pipBtn');
  const unmute  = document.getElementById('unmuteOverlay');

  /* PiP featureâ€‘test */
  const pipOK = ('requestPictureInPicture' in video) ||
                (video.webkitSupportsPresentationMode &&
                 video.webkitSupportsPresentationMode('picture-in-picture'));
  if (!pipOK) pipBtn.classList.add('hidden');

  pipBtn.addEventListener('click', async () => {
    try {
      if (video.requestPictureInPicture) {
        await video.requestPictureInPicture();
      } else {
        await video.webkitSetPresentationMode('picture-in-picture');
      }
      if (video.muted) video.muted = false;
    } catch {}
  });

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && !video.paused) {
      video.play().catch(() => {});
    }
  });

  unmute.addEventListener('click', async () => {
    video.pause();
    video.muted = false;
    unmute.classList.add('hidden');
    await video.play().catch(() => {});
  });

  /* autoâ€‘retry if the media pipeline throws */
  video.addEventListener('error', () => {
    if (video.dataset.bvid) {
      document.dispatchEvent(new CustomEvent('videoâ€‘retry', { detail: video.dataset.bvid }));
    }
  });
})();
</script>