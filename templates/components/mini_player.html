<div id="miniPlayerWrapper"
     class="w-full mb-8 hidden transition-all duration-300 ease-in-out relative">

  <!-- VIDEO -->
  <video id="miniPlayerVideo"
         preload="metadata"
         muted
         loop
         playsinline webkit-playsinline
         controls
         x-webkit-airplay="allow"
         class="w-full h-[460px] rounded-lg shadow-md bg-black">
  </video>

  <!-- Tap-to-unmute overlay -->
  <button id="unmuteOverlay"
          class="absolute inset-0 flex items-center justify-center
                 text-white text-xl font-semibold bg-black/50
                 backdrop-blur-sm rounded-lg hidden">
      ðŸ”Š Tap to unmute
  </button>

  <!-- PiP helper -->
  <button id="pipBtn" class="mt-2 px-4 py-1 bg-blue-600 text-white rounded">
      ðŸŽ§ Play in background
  </button>
</div>

<script>
(() => {
    const wrapper = document.getElementById('miniPlayerWrapper');
    const video   = document.getElementById('miniPlayerVideo');
    const unmute  = document.getElementById('unmuteOverlay');
    const pipBtn  = document.getElementById('pipBtn');

    /* â”€â”€ feature-detect PiP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    if (!video.requestPictureInPicture &&
        !video.webkitSetPresentationMode) {
        pipBtn.classList.add('hidden');          // PiP unsupported
    }

    /* â”€â”€ keep playing when tab regains focus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && !video.paused) {
            video.play().catch(() => {});
        }
    });

    /* â”€â”€ tap-to-unmute overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function maybeShowUnmute () {
        if (video.muted) unmute.classList.remove('hidden');
    }
    unmute.addEventListener('click', async () => {
        video.pause();
        video.muted = false;
        unmute.classList.add('hidden');
        await video.play().catch(()=>{});
    });

    /* â”€â”€ PiP button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    pipBtn.addEventListener('click', async () => {
        try {
            if (video.requestPictureInPicture) {
                await video.requestPictureInPicture();
            } else if (video.webkitSetPresentationMode) {
                video.webkitSetPresentationMode('picture-in-picture');
            }
            if (video.muted) video.muted = false;
            video.addEventListener('ended', () => {
                video.currentTime = 0; video.play().catch(()=>{});
            }, { once:true });
        } catch {
            alert('PiP not available on this device / iOS version.');
        }
    });

    /* â”€â”€ expose a tiny public helper used by pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    window.__miniPlayerPlay = async function (src, highlightCard) {
        /* Bilibiliâ€™s CDN lacks CORS headers â€“ drop the attribute
           so Safari doesnâ€™t block the request. */
        video.removeAttribute('crossorigin');

        video.pause();
        video.src   = src;
        video.muted = true;
        await video.play().catch(()=>{});
        maybeShowUnmute();

        wrapper.classList.remove('hidden');

        document.querySelectorAll('.video-card')
                .forEach(el => el.classList.remove('ring','ring-blue-400'));
        if (highlightCard) highlightCard.classList.add('ring','ring-blue-400');
    };
})();
</script>
